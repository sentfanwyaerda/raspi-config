#/bin/sh

nowtoday=`date +%s`
file=/var/backups/www\[`date +%F --date=@$nowtoday`\].tgz
username=www-data

cd /var
tar -cf $file -z www
chown $username $file
chgrp $username $file
chmod 0644 $file

md5sum $file > $file.md5
chown $username $file.md5
chgrp $username $file.md5
chmod 0644 $file.md5

yesterday=`echo "$nowtoday - 86400" | bc`
prevfile=/var/backups/www\[`date +%F --date=@$yesterday`\].tgz

if [ -f $prevfile.md5 ]; then
	if diff <(cat $prevfile.md5 | cut -d" " -f 1) <(cat $file.md5 | cut -d" " -f 1) >/dev/null ; then
		echo "[backup-www] /var/www/ has been altered since yesterdays backup and $file has the most recent backup."
	else
		echo "[backup-www] Since yesterdays backup ($prevfile) there were no alterations in /var/www "
		rm $file
		rm $file.md5
	fi
fi
